<!--alerts CSS -->
<link href="/static/plugins/bower_components/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
<link href="/static/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading" id="housenameadd">
                    <duv class="pull-right">
                        <a data-toggle="modal" style="cursor: pointer;" data-target="#price-add-modal">添加</a>
                    </duv>
                    <!--<span class="label label-info m-l-10" data-toggle="modal" data-target="#price-add-modal">添加</span>-->
                </div>
                <div class="panel-wrapper">
                    <div class="panel-body">
                        <div class="clearfix"></div>
                        <div>
                            <div id="price-table" class="panel block5" style="position: static; zoom: 1;">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!--add price start-->
    <div class="col-md-4">
        <!-- sample modal content -->
        <!-- /.modal -->
        <div id="price-add-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">添加楼盘价格</h4>
                    </div>
                    <div class="modal-body">
                        <form id="save-price-form" class="form-horizontal" method="post">
                            <!--隐藏域信息-->
                            <input type="hidden" name="newcode" value="">
                            <div class="form-group">
                                <label for="datepicker-add" class="control-label col-sm-2">选择日期:</label>
                                <div class="input-group col-sm-9">
                                    <input type="text" class="form-control" id="datepicker-add" placeholder="yyyy-MM-dd" name="priceDate">
                                    <span class="input-group-addon"><i class="icon-calender"></i></span>
                                </div>
                            </div>
                            <!--<div class="form-group">
                                <label for="message-text" class="control-label">销售类型:</label>
                                <input type="text" class="form-control" id="message-text" name="saleType">
                            </div>-->
                            <div class="form-group">
                                <label for="price-max" class="control-label col-sm-2">最高价:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="price-max" name="priceMax">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="price-min" class="control-label col-sm-2">最低价:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="price-min" name="priceMin">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="price-average" class="control-label col-sm-2">平均价:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="price-average" name="priceAverage">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button id="price-save" type="button" class="btn btn-danger waves-effect waves-light">保存</button>
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Button trigger modal -->
    </div>
    <!--add price end-->

    <!--edit price start-->
    <div class="col-md-4">
        <div id="price-edit-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">编辑楼盘价格</h4> </div>
                    <div class="modal-body" id="price-edit-form">
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="edit-price-save" class="btn btn-danger waves-effect waves-light">保存</button>
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--edit price end-->
    <!-- ============================================================== -->
</div>

<script id="edit-price-form-template" type="text/html">
    <form id="edit-price-form" method="post">
        <!--隐藏域信息-->
        <input type="hidden" name="id" value="{{id}}">
        <input type="hidden" name="updaterId" value="1">
        <div class="form-group">
            <label for="datepicker-edit" class="control-label">报价日期:</label>
            <input type="text" class="form-control" id="datepicker-edit" value="{{priceDate}}" name="priceDate" disabled>
        </div>
        <div class="form-group">
            <label for="edit-sale-type" class="control-label">销售类型:</label>
            <input type="text" class="form-control" id="edit-sale-type" name="saleType" value="{{saleType}}">
        </div>
        <div class="form-group">
            <label for="edit-price-max" class="control-label">最高价:</label>
            <input type="text" class="form-control" id="edit-price-max" name="priceMax" value="{{priceMax}}">
        </div>
        <div class="form-group">
            <label for="edit-price-min" class="control-label">最低价:</label>
            <input type="text" class="form-control" id="edit-price-min" name="priceMin" value="{{priceMin}}">
        </div>
        <div class="form-group">
            <label for="edit-price-average" class="control-label">平均价:</label>
            <input type="text" class="form-control" id="edit-price-average" name="priceAverage" value="{{priceAverage}}">
        </div>
    </form>
</script>

<script src="/static/plugins/bower_components/sweetalert/sweetalert.min.js"></script>
<script src="/static/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
<script src="/static/plugins/bower_components/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.js"></script>
<script src="/static/js/jquery.validate.min.js"></script>
<script src="/static/js/messages_zh.min.js"></script>
<script src="/static/js/toutiao/validator-setDefaults.js"></script>
<script src="/static/js/template-web.js"></script>
<script src="/static/js/toutiao.table.js"></script>
<script src="/static/js/toutiao/common.js"></script>
<script src="/api/project/priceApi.js"></script>
<script src="/api/project/projectApi.js"></script>
<script src="https://cdn.bootcss.com/jquery.serializeJSON/2.8.1/jquery.serializejson.min.js"></script>
<script type="text/javascript">
    var _newCode = getQueryString('newcode');

    $('input[name="newcode"]').val(_newCode);

    loadData(_newCode);

    jQuery('#datepicker-add').datepicker({
        language:'zh-CN',
        autoclose: true,
        todayHighlight: true,
        format:"yyyy-mm-dd",
        pickerPosition: 'bottom-left'
    });

    $('#price-table').ttTable({
        paging:true,
        columns:[
            {
                field:"id",
                "title":"价格ID"
            },
            {
                field:"priceDate",
                "title":"日期"
            },
//            {
//                field:"saleType",
//                "title":"类型"
//            },
            {
                render:function (d) {

                    if (!d["priceMax"]) {
                        return "-";
                    }
                    return d["priceMax"] + d["priceMaxType"];
                },
                "title":"最高价"
            },
            {
                render:function (d) {
                    if (!d["priceMin"]) {
                        return "-";
                    }
                    return d["priceMin"] + d["priceMinType"];
                },
                "title":"最低价"
            },
            {
                render:function (d) {
                    if (!d["priceAverage"]) {
                        return "-";
                    }
                    return d["priceAverage"] + d["priceAverageType"];
                },
                "title":"平均价"
            },
            {
                render:function (d) {
                    return "<div class='button-box'>"
                        + "<button class='btn btn-info price-edit' data-id='" + d['id']+ "'>修改</button>"
                        + "<button class='btn btn-info price-del' data-id='" + d['id']+ "'>删除</button>"
                        + "</div>";
                },
                "title":"管理"
            }

        ],
        onPage:function (pageIndex,pageSize) {
            loadData(_newCode, pageIndex);
        }
    });
    
    function loadData(newcode, pageNum) {
        var loupanname;
        com.toutiao.officedict.project.getEsfHousingProject.do({"newcode":newcode},function (res) {
            if(res!=null||res!=""){
                 // console.log(res.projname)
                loupanname=res.projname;
                  $("#housenameadd").append(loupanname+"—<span>历史价格管理</span>");
            }else{
            console.log("error")
            }
        })



        com.toutiao.officedict.price.listProjectPrice.do({"newcode":newcode, "pageNum":pageNum},function(res, pageNum, pageSize, total){

            $('#price-table').ttTable().showloading();
            $('#price-table').ttTable().load(res, total, pageNum);

            $('.price-edit').each(function () {
                $(this).click(function () {
                    com.toutiao.officedict.price.getProjectPrice.do({"id": $(this).data('id')},function(res){
                        var priceHtml = template('edit-price-form-template', res);
                        $('#price-edit-form').html(priceHtml);

                        $('#price-edit-modal').modal();
                    },function (jqXHR, textStatus, errorThrown) {
                        console.log('error',jqXHR, textStatus, errorThrown)
                    });

                });
            });

            //删除
            $('.price-del').each(function () {
                $(this).click(function () {
                    var _delId = $(this).data('id');

                    swal({
                        title: "确定删除吗？",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonText: "确定",
                        cancelButtonText: "取消",
                        closeOnConfirm: false
                    },function () {
                        com.toutiao.officedict.price.deleteProjectPrice.do({'id': _delId}, function (res, success, error) {
                            if (res && res>0) {
                                swal({
                                    title: "删除成功!",
                                    type: "success",
                                    confirmButtonText: "确定",
                                    closeOnConfirm: false
                                }, function () {
                                    loadData(newcode);
                                    swal.close();
                                });
                            }
                        },function (jqXHR, textStatus, errorThrown) {
                            console.log('error',jqXHR, textStatus, errorThrown)
                        });
                    })
                });
            });

        },function (jqXHR, textStatus, errorThrown) {
            console.log('error',jqXHR, textStatus, errorThrown)
        });

    }

    //录入
    $('#price-save').click(function () {
        $('#save-price-form').submit();
    });

    //更新
    $('#edit-price-save').on('click', function () {
        if (!$('#edit-price-max').val()){
            $('#edit-price-max').focus();
            return false;
        }

        var result = $('#edit-price-form').serializeJSON();
        com.toutiao.officedict.price.updateProjectPrice.do(result, function  (res, success, error) {
            console.log(res)
            if (res && res>0) {
                swal({
                    title: "保存成功!",
                    type: "success",
                    confirmButtonText: "确定",
                    closeOnConfirm: false
                }, function () {
                    $('#price-edit-modal').modal('hide');
                    loadData(_newCode);
                    swal.close();
                });

            }
        },function (jqXHR, textStatus, errorThrown) {
            console.log('error',jqXHR, textStatus, errorThrown)
        });
    });


    //新增表单验证
    $('#save-price-form').validate({
        rules: {
            priceDate: 'required'
        },
        messages: {
            priceDate: '请选择报价日期'
        },
        submitHandler: function(){
            var result = $('#save-price-form').serializeJSON();
            com.toutiao.officedict.price.saveProjectPrice.do(result, function (res, success, error) {
                if (res && res>0) {
                    swal({
                        title: "保存成功!",
                        type: "success",
                        confirmButtonText: "确定",
                        closeOnConfirm: false
                    }, function () {
                        $('#price-add-modal').modal('hide');

                        loadData(_newCode);
                        swal.close();
                    });

                }
            },function (jqXHR, textStatus, errorThrown) {
                console.log('error',jqXHR, textStatus, errorThrown)
            });

        }
    });
</script>