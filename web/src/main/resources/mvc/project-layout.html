<link href="/static/plugins/bower_components/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
<link href="/static/plugins/bower_components/Magnific-Popup-master/dist/magnific-popup.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/toutiao/css/user-defined.css">
<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12 col-sm-12 col-xs-12">
            <div class="panel panel-info">
                <div class="panel-heading">楼盘户型管理
                    <duv class="pull-right">
                        <a style="cursor: pointer;" data-toggle="modal" data-target="#layout-add-modal">新增户型</a>
                    </duv>
                </div>

                <div class="panel-wrapper">
                    <div class="panel-body">
                        <div class="clearfix"></div>
                        <div>
                            <div id="project-layout-table" class="panel block5" style="position: static; zoom: 1;">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================== -->
    <!--modal start-->
    <div class="col-md-4">
        <!--添加户型modal start-->
        <div id="layout-add-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">新增户型</h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal" id="save-layout-form" method="post">
                            <!--隐藏域信息-->
                            <input type="hidden" name="newcode" value="">
                            <div class="form-group">
                                <label for="layout-title" class="control-label col-sm-2">户型名称:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="layout-title" name="layoutTitle">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="room" class="control-label col-sm-2">室:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="room" name="room">
                                </div>
                                <label for="hall" class="control-label col-sm-2">厅:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="hall" name="hall">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="kitchen" class="control-label col-sm-2">厨:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="kitchen" name="kitchen">
                                </div>

                                <label for="toilet" class="control-label col-sm-2">卫:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="toilet" name="toilet">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="building-area" class="control-label col-sm-2">建筑面积:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="building-area" name="buildingArea">
                                </div>

                                <label for="living-area" class="control-label col-sm-2">居住面积:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="living-area" name="livingArea">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="sale-area" class="control-label col-sm-2">销售面积:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="sale-area" name="saleArea">
                                </div>
                            </div>

                         <!--   <div class="form-inline form-group" style="margin-left: 9px">
                                <label for="building-area" class="control-label ">建筑面积:</label>
                                <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control mb-2 mr-sm-2" id="building-area" name="buildingArea">

                                <label for="living-area" class="control-label ">居住面积:</label>
                                <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control  mb-2 mr-sm-2" id="living-area" name="livingArea">

                                <label for="sale-area" class="control-label ">销售面积:</label>
                                <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control" id="sale-area" name="saleArea">
                            </div>-->

                            <div class="form-group">
                                <label for="reference-price" class="control-label col-sm-2">参考均价（元/㎡）:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="reference-price" name="referencePrice">
                                </div>

                                <label for="reference-total-price" class="control-label col-sm-2">参考总价（万元）:</label>
                                <div class="col-sm-3">
                                    <input type="text" class="form-control" id="reference-total-price" name="referenceTotalPrice">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="reference-sell-state" class="control-label col-sm-2">销售状态:</label>
                                <div class="col-sm-4">
                                    <select id="reference-sell-state"  name="salesStatus" class="form-control">
                                        <option value ="0" {{if salesStatus==0}}selected{{/if}}>售完</option>
                                        <option value ="1" {{if salesStatus==1}}selected{{/if}}>在售</option>
                                        <option value="2" {{if salesStatus==2}}selected{{/if}}>不在售</option>
                                        <option value="3" {{if salesStatus==3}}selected{{/if}}>出租</option>
                                        <option value="4" {{if salesStatus==4}}selected{{/if}}>租售</option>
                                        <option value="5" {{if salesStatus==5}}selected{{/if}}>待售</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="layout-desc" class="control-label col-sm-2">户型描述:</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="layout-desc" name="layoutDesc"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tag" class="control-label col-sm-2">标签:</label>
                                <div class="col-sm-9" id="tag">
                                    <!--<input type="text" class="form-control" id="tag" name="tag">-->
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="tag[]" value="南北通透">南北通透
                                    </label>
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="tag[]" value="全明格局">全明格局
                                    </label>
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="tag[]" value="户型方正">户型方正
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="is-recommend" class="control-label col-sm-2">是否主推:</label>
                                <div class="col-sm-9" id="is-recommend">
                                    <label class="radio-inline">
                                        <div class="radio radio-info">
                                            <input type="radio" name="isRecommend" id="isRecommend-no" value="0">
                                            <label for="isRecommend-no">否</label>
                                        </div>
                                    </label>
                                    <label class="radio-inline">
                                        <div class="radio radio-info">
                                            <input type="radio" name="isRecommend" id="isRecommend-yes" value="1">
                                            <label for="isRecommend-yes">是</label>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button id="layout-save" type="button" class="btn btn-danger waves-effect waves-light">保存</button>
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--添加户型modal end-->

        <!--更新户型modal start-->
        <div id="layout-edit-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">编辑楼盘户型</h4> </div>
                    <div class="modal-body" id="layout-edit-form">
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="edit-layout-save" class="btn btn-danger waves-effect waves-light">保存</button>
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
        <!--更新户型modal end-->

    </div>
    <!--modal end-->
</div>

<script id="edit-layout-form-template" type="text/html">
    <form id="edit-layout-form" class="form-horizontal" method="post">
        <!--隐藏域信息-->
        <input type="hidden" name="layoutId" value="{{layoutId}}">
        <div class="form-group">
            <label for="edit-layout-title" class="control-label col-sm-2">户型名称:</label>
            <div class="col-sm-9">
                <input type="text" class="form-control" id="edit-layout-title" name="layoutTitle" value="{{layoutTitle}}">
            </div>
        </div>

     <!--   <div class="form-group">
            <label for="edit-room" class="control-label col-sm-2">室:</label>
            <div class="col-sm-3">
            <input type="text" class="form-control" id="edit-room" name="room" value="{{room}}">
            </div>
        </div>
       <div class="form-group">
            <label for="edit-hall" class="control-label col-sm-2">厅:</label>
            <div class="col-sm-3">
                <input type="text" class="form-control" id="edit-hall" name="hall" value="{{hall}}">
            </div>
        </div>-->

        <div class="form-inline form-group" style="margin-left: 9px">
                 <label for="edit-room" class="control-label ">室:</label> <input style="width: 60px;margin-right: 40px;margin-left:15px" type="text" class="form-control mb-2 mr-sm-2" id="edit-room" name="room" value="{{room}}">
                <label for="edit-hall" class="control-label ">厅:</label> <input style="width: 60px;margin-right: 40px;margin-left:15px" type="text" class="form-control  mb-2 mr-sm-2" id="edit-hall" name="hall" value="{{hall}}">
                <label for="edit-kitchen" class="control-label ">厨:</label> <input style="width: 60px;margin-right: 40px;margin-left:15px" type="text" class="form-control" id="edit-kitchen" name="kitchen" value="{{kitchen}}">
                <label for="edit-toilet" class="control-label ">卫:</label> <input style="width: 60px;margin-right: 40px;margin-left:15px" type="text" class="form-control" id="edit-toilet" name="toilet" value="{{toilet}}">
        </div>


       <!-- <div class="form-inline ">
            <label for="edit-kitchen" class="control-label ">厨:</label> <input type="text" class="form-control" id="edit-kitchen" name="kitchen" value="{{kitchen}}">
            <label for="edit-toilet" class="control-label ">卫:</label> <input type="text" class="form-control" id="edit-toilet" name="toilet" value="{{toilet}}">
        </div>-->

        <div class="form-inline form-group" style="margin-left: 9px">
            <label for="edit-building-area" class="control-label ">建筑面积:</label>
            <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control mb-2 mr-sm-2" id="edit-building-area" name="buildingArea" value="{{buildingArea}}">

            <label for="edit-living-area" class="control-label ">居住面积:</label>
            <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control  mb-2 mr-sm-2" id="edit-living-area" name="livingArea" value="{{livingArea}}">

            <label for="edit-sale-area" class="control-label ">销售面积:</label>
            <input style="width: 70px;margin-right: 40px;margin-left:15px" type="text" class="form-control" id="edit-sale-area" name="saleArea" value="{{saleArea}}">
        </div>

        <div class="form-group">
            <label for="edit-reference-total-price" class="control-label col-sm-2">参考总价:</label>
            <div class="col-sm-9">
                <input type="text" class="form-control" id="edit-reference-total-price" name="referenceTotalPrice" value="{{referenceTotalPrice}}">
            </div>
        </div>

        <div class="form-group">
            <label for="edit-reference-sell-state" class="control-label col-sm-2">销售状态:</label>
            <div class="col-sm-4">
            <select id="edit-reference-sell-state"  name="salesStatus" class="form-control">
                <option value ="0" {{if salesStatus==0}}selected{{/if}}>售完</option>
                <option value ="1" {{if salesStatus==1}}selected{{/if}}>在售</option>
                <option value="2" {{if salesStatus==2}}selected{{/if}}>不在售</option>
                <option value="3" {{if salesStatus==3}}selected{{/if}}>出租</option>
                <option value="4" {{if salesStatus==4}}selected{{/if}}>租售</option>
                <option value="5" {{if salesStatus==5}}selected{{/if}}>待售</option>
            </select>
            </div>
        </div>

        <div class="form-group">
            <label for="edit-layout-desc" class="control-label col-sm-2">户型描述:</label>
            <div class="col-sm-9">
                <textarea class="form-control" id="edit-layout-desc" name="layoutDesc">{{layoutDesc}}</textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-tag" class="control-label col-sm-2">标签:</label>
            <div class="col-sm-9" id="edit-tag" data-value="{{tag}}">
                <!--<input type="text" class="form-control" id="edit-tag" name="tag" value="{{tag}}">-->
            </div>
        </div>
        <div class="form-group">
            <label for="edit-is-recommend" class="control-label col-sm-2">是否主推:</label>
            <div class="col-sm-9" id="edit-is-recommend">
                {{if isRecommend==0}}
                    <label class="radio-inline">
                        <div class="radio radio-info">
                            <input type="radio" name="isRecommend" checked value="0">
                            <label>否</label>
                        </div>
                    </label>
                    <label class="radio-inline">
                        <div class="radio radio-info">
                            <input type="radio" name="isRecommend" value="1">
                            <label>是</label>
                        </div>
                    </label>
                {{else}}
                    <label class="radio-inline">
                        <div class="radio radio-info">
                            <input type="radio" name="isRecommend" value="0">
                            <label>否</label>
                        </div>
                    </label>
                    <label class="radio-inline">
                        <div class="radio radio-info">
                            <input type="radio" name="isRecommend" checked value="1">
                            <label>是</label>
                        </div>
                    </label>
                {{/if}}
            </div>
        </div>

    </form>
</script>

<script src="/static/plugins/bower_components/Magnific-Popup-master/dist/jquery.magnific-popup.min.js"></script>
<script src="/static/plugins/bower_components/Magnific-Popup-master/dist/jquery.magnific-popup-init.js"></script>
<script src="/static/plugins/bower_components/sweetalert/sweetalert.min.js"></script>
<script src="/static/js/jquery.validate.min.js"></script>
<script src="/static/js/additional-methods.min.js"></script>
<script src="/static/js/messages_zh.min.js"></script>
<script src="/static/js/toutiao/validator-setDefaults.js"></script>
<script src="https://cdn.bootcss.com/jquery.serializeJSON/2.8.1/jquery.serializejson.min.js"></script>
<script src="/static/js/toutiao.table.js"></script>
<script src="/static/js/toutiao/common.js"></script>
<script src="/api/newHouse/newHouseApi.js"></script>
<script src="/api/project/projectApi.js"></script>
<script type="text/javascript">
    var _newCode = getQueryString('newcode');
    $('input[name="newcode"]').val(_newCode);

    loadData(_newCode);

    $('#project-layout-table').ttTable({
        paging:true,
        columns:[
            {
                field:"layoutId",
                "title":"户型ID"
            },
            {
                field:"layoutTitle",
                "title":"户型名称"
            },
            {
                render:function (d) {
                  return d['room'] + "室" + d['hall'] + "厅" + d['toilet'] + "卫" + d['kitchen'] +"厨";
                },
                "title":"户型"
            },
            {
                render:function (d) {

                    if(!d['referencePrice'])
                        return "待定";
                    return d['referencePrice'] + "元/㎡";
                },
                "title":"参考均价"
            },
            {
                render:function (d) {

                    if(!d['referenceTotalPrice'])
                        return "待定";
                    return d['referenceTotalPrice'] + "万元/套";
                },
                "title":"参考总价"
            },
            {
                render:function (d) {
                    return "<div class='button-box'>"
                        + "<button class='btn btn-info layout-image' data-id='" + d['layoutId']+ "'>户型图管理</button>"
                        + "<button class='btn btn-info layout-edit' data-id='" + d['layoutId']+ "'>修改</button>"
                        + "<button class='btn btn-info layout-del' data-id='" + d['layoutId']+ "'>删除</button>"
                        + "</div>";
                },
                "title":"管理"
            }

        ],
        onPage:function (pageIndex,pageSize) {
            loadData(_newCode, pageIndex);
        }
    });

    //加载列表数据
    function loadData(newcode, pageNum) {
        com.toutiao.officedict.newHouse.listHousingProjectLayout.do({"newcode":newcode, "pageNum":pageNum},function(res, pageNum, pageSize, total){

            $('#project-layout-table').ttTable().showloading();
            $('#project-layout-table').ttTable().load(res, total, pageNum);

            //上传户型图
            $('.layout-image').each(function () {
                var _id = $(this).data('id');
                $(this).on('click', function () {
                    window.location = '/index#mvc/project-layout-image.html' + '?newcode=' + _newCode + '&layout=' + _id;
                });
            });

            //更新
            $('.layout-edit').each(function () {
                $(this).click(function () {
                    com.toutiao.officedict.newHouse.getHousingProjectLayout.do({"id": $(this).data('id')},function(res){
                        var layoutHtml = template('edit-layout-form-template', res);
                        $('#layout-edit-form').html(layoutHtml);
                        renderLayoutTag();
                        //更新校验
                        validateUpdate();

                        $('#layout-edit-modal').modal();
                    },function (jqXHR, textStatus, errorThrown) {
                        console.log('error',jqXHR, textStatus, errorThrown)
                    });

                });
            });

            //删除
            $('.layout-del').each(function () {
                $(this).click(function () {
                    var _delId = $(this).data('id');

                    swal({
                        title: "确定删除吗？",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonText: "确定",
                        cancelButtonText: "取消",
                        closeOnConfirm: false
                    },function () {
                        com.toutiao.officedict.newHouse.deleteHousingProjectLayout.do({'layoutId': _delId}, function (res, success, error) {
                            if (res && res>0) {
                                var dateTime ={newcode:_newCode};
                                com.toutiao.officedict.project.updateHousingProject.do(dateTime,function (res){
                                    if (res && res>0) {
                                        swal({
                                            title: "删除成功!",
                                            type: "success",
                                            confirmButtonText: "确定",
                                            closeOnConfirm: false
                                        }, function () {
                                            loadData(newcode);
                                            swal.close();
                                        });
                                    };
                                })
                            }
                        },function (jqXHR, textStatus, errorThrown) {
                            console.log('error',jqXHR, textStatus, errorThrown)
                        });
                    })
                });
            });

        },function (jqXHR, textStatus, errorThrown) {
            console.log('error',jqXHR, textStatus, errorThrown)
        });

    }

    //新增
    $('#layout-save').on('click', function(){
        $('#save-layout-form').submit();
    });

    //新增表单验证
    $('#save-layout-form').validate({
        rules: {
            layoutTitle: 'required',
            room: {
                required: true,
                number:true
            },
            hall: {
                required: true,
                number:true
            },
//            kitchen: {
//                required: true,
//                number:true
//            },
            toilet: {
                required: true,
                number:true
            },
            buildingArea: {
                required: true,
                number:true
            }
//            ,
//            referencePrice: {
//                required: true,
//                number:true
//            },
//            referenceTotalPrice: {
//                required: true,
//                number:true
//            }
        },
        messages: {
            layoutTitle: '请输入户型名称',
            room: {
                required:'请输入几室',
                number:'请输入有效的数字'
            },
            hall: {
                required:'请输入几厅',
                number:'请输入有效的数字'
            },
//            kitchen: {
//                required:'请输入几厨',
//                number:'请输入有效的数字'
//            },
            toilet: {
                required:'请输入几卫',
                number:'请输入有效的数字'
            },
            buildingArea: {
                required: '请输入户型建筑面积',
                number:'请输入有效的数字'
            }
//            ,
//            referencePrice: {
//                required: '请输入该户型均价',
//                number:'请输入有效的数字'
//            },
//            referenceTotalPrice: {
//                required: '请输入该户型总价',
//                number:'请输入有效的数字'
//            }
        },
        submitHandler: function(){
            var result = $('#save-layout-form').serializeJSON();
            com.toutiao.officedict.newHouse.saveHousingProjectLayout.do(result, function (res, success, error) {
                if (res && res>0) {
                    var dateTime ={newcode:_newCode};
                    com.toutiao.officedict.project.updateHousingProject.do(dateTime,function (res){
                        if (res && res>0) {
                            swal({
                                title: "保存成功!",
                                type: "success",
                                confirmButtonText: "确定",
                                closeOnConfirm: false
                            }, function () {
                                $('#layout-add-modal').modal('hide');
                                loadData(_newCode);
                                swal.close();
                            });
                        };
                    })
                }
            },function (jqXHR, textStatus, errorThrown) {
                console.log('error',jqXHR, textStatus, errorThrown)
            });

        }
    });


    //更新表单校验
    function validateUpdate() {
        //更新
        $('#edit-layout-save').on('click', function () {
            $('#edit-layout-form').submit();
        });
        //更新表单验证
        $('#edit-layout-form').validate({
            rules: {
                layoutTitle: 'required',
                room: {
                    required: true,
                    number:true
                },
                hall: {
                    required: true,
                    number:true
                },
                kitchen: {
                    required: true,
                    number:true
                },
                toilet: {
                    required: true,
                    number:true
                },
                buildingArea: {
                    required: true,
                    number:true
                }
//                ,
//                referencePrice: {
//                    required: true,
//                    number:true
//                },
//                referenceTotalPrice: {
//                    required: true,
//                    number:true
//                }
            },
            messages: {
                layoutTitle: '请输入户型名称',
                room: {
                    required:'请输入几室',
                    number:'请输入有效的数字'
                },
                hall: {
                    required:'请输入几厅',
                    number:'请输入有效的数字'
                },
                kitchen: {
                    required:'请输入几厨',
                    number:'请输入有效的数字'
                },
                toilet: {
                    required:'请输入几卫',
                    number:'请输入有效的数字'
                },
                buildingArea: {
                    required: '请输入该户型建筑面积',
                    number:'请输入有效的数字'
                }
//                ,
//                referencePrice: {
//                    required: '请输入该户型均价',
//                    number:'请输入有效的数字'
//                },
//                referenceTotalPrice: {
//                    required: '请输入该户型总价',
//                    number:'请输入有效的数字'
//                }
            },
            submitHandler: function(){
                var result = $('#edit-layout-form').serializeJSON();
                com.toutiao.officedict.newHouse.updateHousingProjectLayout.do(result, function  (res, success, error) {
                    if (res && res>0) {
                        var dateTime ={newcode:_newCode};
                        com.toutiao.officedict.project.updateHousingProject.do(dateTime,function (res){
                            if (res && res>0) {
                                swal({
                                    title: "保存成功!",
                                    type: "success",
                                    confirmButtonText: "确定",
                                    closeOnConfirm: false
                                }, function () {
                                    $('#layout-edit-modal').modal('hide');
                                    loadData(_newCode);
                                    swal.close();
                                });
                            };
                        })
                    }
                },function (jqXHR, textStatus, errorThrown) {
                    console.log('error',jqXHR, textStatus, errorThrown)
                });

            }
        });
    };

    function renderLayoutTag() {
        var tagArray = ['南北通透', '全明格局', '户型方正'];

        var _value = $('#edit-tag').data('value');

        var _tagHtml = "";
        $.each(tagArray, function (key, val) {
            if ($.inArray(val, _value) >= 0) {
                _tagHtml += "<label class=\"checkbox-inline\">\n" +
                    "<input type=\"checkbox\" checked name=\"tag[]\" value='" + val + "'>" + val + "\n" +
                    "</label>";
            } else {
                _tagHtml += "<label class=\"checkbox-inline\">\n" +
                    "<input type=\"checkbox\" name=\"tag[]\" value='" + val + "'>" + val + "\n" +
                    "</label>";
            }
        });
        $('#edit-tag').html(_tagHtml);
    };
</script>